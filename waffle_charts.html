
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Waffle Charts</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      color: #333;
      background-color: #e0e0e0; /* Light background for the whole page */
      padding-left: 20px; /* Align the body content to the left */
    }
    .chart-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .chart-subtitle {
      font-size: 16px;
      color: #666;
      margin-top: 0;
      margin-bottom: 20px;
    }
    .charts-and-legend {
      display: flex;
      align-items: flex-start;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      max-width: 1200px; /* Increased width to allow more space */
    }
    .charts {
      flex: 0 0 850px; /* Increased width for the charts */
    }
    .waffle-chart-container {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .waffle-chart {
      shape-rendering: crispEdges;
      margin-left: 10px;
    }
    .square {
      stroke: #fff;
    }
    .chart-label {
      font-size: 16px;
      font-weight: bold;
      width: 80px;
      margin-left: 15px;
      margin-right: 5px;
    }
    .legend {
      width: 180px; /* Increased width for longer labels */
      margin-left: 40px; /* Increased margin to space out the legend */
      display: flex;
      flex-direction: column;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      white-space: nowrap; /* Prevent labels from wrapping to multiple lines */
    }
    .legend-color {
      width: 15px;
      height: 15px;
      margin-right: 5px;
      border: 1px solid #ccc; /* Border around color squares */
    }
    .chart-footer {
      font-size: 12px;
      color: #999;
      margin-top: 10px;
      text-align: left; /* Align footer to the left */
    }
    .axis-label {
      text-align: center;
      font-size: 14px;
      margin-top: 5px;
      margin-left: 15px;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1 class="chart-title">
        "List top 5 factors that make a good electric car."
      </h1>
      <p class="chart-subtitle">
        Model Temperature: Defaults<br>
        Date Run: 26.09.2024
      </p>
    </header>

    <section class="charts-and-legend">
      <div class="charts">
        <div class="waffle-chart-container">
          <div class="chart-label">llama3</div>
          <svg width="850" height="150" id="chart_llama" class="waffle-chart"></svg>
        </div>
        <div class="waffle-chart-container">
          <div class="chart-label">gpt-3.5</div>
          <svg width="850" height="150" id="chart_gpt3_5" class="waffle-chart"></svg>
        </div>
        <div class="waffle-chart-container">
          <div class="chart-label">gpt-4</div>
          <svg width="850" height="150" id="chart_gpt" class="waffle-chart"></svg>
        </div>
        <div class="waffle-chart-container">
          <div class="chart-label">gpt-4o-mini</div>
          <svg width="850" height="150" id="chart_gpt4o_mini" class="waffle-chart"></svg>
        </div>
        <!-- Axis Label -->
        <div class="axis-label">Number of iterations where factor was present</div>
      </div>
      <!-- Legend on the right side -->
      <div class="legend" id="chart_legend"></div>
    </section>

    <footer class="chart-footer">
      Data Source: Your Data Source Here<br>
      Note: Additional notes if necessary.
    </footer>
  </main>

  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script>
    var data_llama = [{"product": "range", "count": 108}, {"product": "efficiency", "count": 98}, {"product": "comfort", "count": 49}, {"product": "safety", "count": 35}, {"product": "sustainability", "count": 27}, {"product": "performance", "count": 22}, {"product": "powertrain", "count": 21}, {"product": "reliability", "count": 21}, {"product": "style", "count": 13}, {"product": "design", "count": 12}, {"product": "tech", "count": 12}, {"product": "infotainment", "count": 11}, {"product": "charging", "count": 11}, {"product": "technology", "count": 10}, {"product": "power", "count": 6}, {"product": "practicality", "count": 6}, {"product": "battery", "count": 5}, {"product": "silence", "count": 3}, {"product": "charger", "count": 3}, {"product": "durability", "count": 3}];
    var data_gpt3_5 = [{"product": "efficiency", "count": 99}, {"product": "range", "count": 88}, {"product": "performance", "count": 80}, {"product": "safety", "count": 57}, {"product": "charging", "count": 45}, {"product": "sustainability", "count": 43}, {"product": "reliability", "count": 35}, {"product": "technology", "count": 18}, {"product": "battery", "count": 9}, {"product": "durability", "count": 6}, {"product": "acceleration", "count": 5}, {"product": "speed", "count": 2}, {"product": "comfort", "count": 2}, {"product": "longevity", "count": 2}, {"product": "innovation", "count": 2}, {"product": "power", "count": 1}, {"product": "convenience", "count": 1}, {"product": "efficient", "count": 1}, {"product": "reliable", "count": 1}, {"product": "sustainable", "count": 1}];
    var data_gpt = [{"product": "efficiency", "count": 100}, {"product": "range", "count": 95}, {"product": "performance", "count": 87}, {"product": "sustainability", "count": 78}, {"product": "reliability", "count": 49}, {"product": "charging", "count": 39}, {"product": "durability", "count": 19}, {"product": "affordability", "count": 12}, {"product": "comfort", "count": 6}, {"product": "time", "count": 4}, {"product": "speed", "count": 4}, {"product": "maintenance", "count": 2}, {"product": "acceleration", "count": 2}, {"product": "battery", "count": 1}, {"product": "chargeability", "count": 1}, {"product": "convenience", "count": 1}];
    var data_gpt4o_mini = [{"product": "range", "count": 99}, {"product": "efficiency", "count": 99}, {"product": "safety", "count": 96}, {"product": "comfort", "count": 77}, {"product": "performance", "count": 37}, {"product": "technology", "count": 32}, {"product": "reliability", "count": 30}, {"product": "charging", "count": 27}, {"product": "design", "count": 2}, {"product": "autonomy", "count": 1}];

    // Function to process data and group items into "other"
    function processData(data) {
      const filteredData = [];
      let otherCount = 0;
      data.forEach(d => {
        if (d.count >= 15) {
          filteredData.push(d);
        } else {
          otherCount += d.count;
        }
      });
      if (otherCount > 0) {
        filteredData.push({ product: "other", count: otherCount });
      }
      return filteredData;
    }

    // Process data for each chart
    const processedData_llama = processData(data_llama);
    const processedData_gpt3_5 = processData(data_gpt3_5);
    const processedData_gpt = processData(data_gpt);
    const processedData_gpt4o_mini = processData(data_gpt4o_mini);

    // Collect products from filteredData arrays
    const allProductsSet = new Set();
    [processedData_llama, processedData_gpt3_5, processedData_gpt, processedData_gpt4o_mini].forEach(filteredData => {
      filteredData.forEach(d => {
        allProductsSet.add(d.product);
      });
    });
    const allProducts = Array.from(allProductsSet).sort();

    // Define the color palette without brown and ensure "other" is light grey
    const professionalColors = [
      "#1f77b4", // Blue
      "#ff7f0e", // Orange
      "#2ca02c", // Green
      "#d62728", // Red
      "#9467bd", // Purple
      "#e377c2", // Pink
      "#7f7f7f", // Gray
      "#bcbd22", // Olive
      "#17becf", // Teal
      "#ffbb78", // Light Orange
      "#98df8a"  // Light Green
    ];

    // Assign colors to products consistently across charts
    const assignedColors = {};
    const lightGreyColor = "#d3d3d3"; // Light grey for "other"

    allProducts.forEach((product, index) => {
      if (product === "other") {
        assignedColors[product] = lightGreyColor;
      } else {
        assignedColors[product] = professionalColors[index % professionalColors.length];
      }
    });

    // Function to assign a color to each product
    function assignColor(product) {
      return assignedColors[product] || lightGreyColor; // Default to light grey if product not assigned
    }

    // Function to draw a waffle chart with consistent item order
    const drawWaffleChart = (filteredData, svgId, topMargin) => {
      const svg = d3.select(svgId);
      const width = +svg.attr("width");
      const height = +svg.attr("height");

      // Create a mapping from product to count
      const productCounts = new Map();
      filteredData.forEach(d => {
        productCounts.set(d.product, d.count);
      });

      // Build blocks in the same order for each chart
      const blocks = [];
      allProducts.forEach(product => {
        const count = productCounts.get(product) || 0;
        const color = assignColor(product);
        for (let i = 0; i < count; i++) {
          blocks.push({ product, color });
        }
      });

      const maxBlocksY = 8;
      const blockSize = 10;
      const blockPadding = 2;
      const margin = { left: 10, top: topMargin };

      svg.selectAll(".square")
        .data(blocks)
        .enter()
        .append("rect")
        .attr("class", "square")
        .attr("width", blockSize)
        .attr("height", blockSize)
        .attr("x", (d, i) => margin.left + Math.floor(i / maxBlocksY) * (blockSize + blockPadding))
        .attr("y", (d, i) => margin.top + (i % maxBlocksY) * (blockSize + blockPadding))
        .attr("fill", d => d.color);
    };

    // Function to create a single legend
    function createLegend() {
      const legendContainer = d3.select("#chart_legend");
      const products = allProducts;

      products.forEach(product => {
        const legendItem = legendContainer.append("div")
          .attr("class", "legend-item");

        legendItem.append("div")
          .attr("class", "legend-color")
          .style("background-color", assignColor(product));

        legendItem.append("div")
          .text(product);
      });
    }

    // Draw the charts
    drawWaffleChart(processedData_llama, "#chart_llama", 10);
    drawWaffleChart(processedData_gpt3_5, "#chart_gpt3_5", 10);
    drawWaffleChart(processedData_gpt, "#chart_gpt", 10);
    drawWaffleChart(processedData_gpt4o_mini, "#chart_gpt4o_mini", 10);

    // Create the single legend
    createLegend();
  </script>
</body>
</html>
